<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="demo.css">
</head>

<body>
    <div class="container"><div class="mia"></div>

        <h1>Demo grid - node.js | bootstrap | jquery |  AJAX | css </h1>

        <div class="row well">
            <div class="col-md-3 personName" id="personName" contenteditable>Naomi Yoshida</div>
            <div class="col-md-6"> Players <span class="badge">4</span></div>
            <div class="col-md-3">
                
            </div>


            
        </div>

        <div class="row well">
            <div class="col-md-9">
                <strong>Game Board </strong><span id="gb-section-long-lat"></span>
                <table id="gameBoard">
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">
                <strong>Game Log</strong>
                <div id="gameBoardLog" class="gameBoardLog">
                   

                    <ul>
                        <li>Console interface - chat area?</li>
                        <li>Console interface - charactor, inventory, health?</li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="row well">
            <strong>Controls</strong>
            <button id="button-left" class="btn btn-default" type="submit">Left</button> 
            <button id="button-right" class="btn btn-default" type="submit">Right</button> 
            <button id="button-up" class="btn btn-default" type="submit">Up</button> 
            <button id="button-down" class="btn btn-default" type="submit">Down</button> 
            &nbsp;

            <button id="button-clear-log" class="btn btn-default" type="submit">Clear log</button>
            <button id="button-modal" class="btn btn-default" type="submit">Launch Modal</button>
            

            
            <button id="button-new-game" class="btn btn-default" type="submit">New Game</button>
            <button id="button-attack-hit" class="btn btn-default" type="submit">Attack hit</button>
            
        </div>


        <div class="row well">
            Created by David Yoshida
        </div>

    </div>


    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h1 class="modal-title" id="myModalLabel">Modal title</h1>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer center">

                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                    <button id="button-start-game" class="btn btn-default" type="submit" data-dismiss="modal">Start New Game</button>
                    &nbsp;
                    <button type="button" class="btn btn-primary">Attack</button>
                    <button type="button" class="btn btn-primary">Enter</button>

                   
                </div>
            </div>
        </div>
    </div>


    <script>
        var GLOBAL_SECTION_SIZE_X = 8;
        var GLOBAL_SECTION_SIZE_Y = 12;

        var xGBSector = 0; // GB sector co-ordinates
        var yGBSector = 0; // GB sector co-ordinates

        // Init global vars;
        var xPos, yPos, xMax, yMax, icon, personID, tickCounter, movementRate;
        var npcArray;

        npcArray = new Array(0);

        icon = "naomi";
        personID = -1;
        gbName = "nil";
        movementRate = 100;
        tickCounter = 0;


        // Start the fun!
        $(document).ready(function () {

            var socket = io.connect();

            // Listen for server messages.
            socket.on('new message', function (data) {
                log('<strong>' + data + '</strong>');
            })
                
            // Listen for server messages.
            socket.on('new movement', function (data) {
                //log('<strong>SERVER:' + data + '</strong>');
                var json = JSON.parse(data);

                var index = findInArray(npcArray, json.id);

                if (index >= 0) { // found!, so update co-ordinates

                    if (json.face == 'fN' || json.face == 'fS') json.face = npcArray[index].face;  // Leave the last facing direction on N and S movement
                    //if (json.face == 'fN') json.face = npcArray[index].face;  // Leave the last facing direction on N and S movement
                    npcArray[index] = json;
                }
                else
                    npcArray.push(json);
                
                // Only draw person on the same gameboard section as you to save performance
                if (json.xGBSector == xGBSector && json.yGBSector == yGBSector)
                    draw();

            })

            socket.on('remove person', function (data) {

                var json = JSON.parse(data);
                log('<strong>' + data + '</strong>');

                var index = findInArray(npcArray, json.id);
                npcArray.splice(index, 1);
                draw();  // Call the draw

                if (personID == json.id) {
                    alert('game over!');
                    personID = -1;

                }
            })





            $("#button-left").click(function () {
                movement('left');
            });

            $("#button-right").click(function () {
                movement('right')
            });

            $("#button-up").click(function () {
                movement('up')
            });

            $("#button-down").click(function () {
                movement('down')
            });


            
            $("#button-clear-log").click(function () {
                resetLog();
            });

            $("#button-modal").click(function () {
                alert("hi");
                modal("monster-mount1");

            });



            $("#button-new-game").click(function () {
                modal("start-game");
            });


            $("#button-attack-hit").click(function () {
                $('body').css('background-color', 'red');
                
                setTimeout(function () {
                    //    $rows.removeClass("pageLoad");
                    $('body').css('background-color', 'lightblue');
                }, 500);

            });




            $("#button-start-game").click(function () {

                //  New game request
                $.ajax({
                    type: "POST",
                    url: '/newGame',
                    data: { name: $("#personName").html(), icon: icon },
                    async: true,
                    dataType: 'text',   //you may use jsonp for cross origin request
                    crossDomain: true,
                    success: function (data, status) {

                        var json = JSON.parse(data);                        

                        personID = json.id;
                        xPos = json.xPos;  // overwrite from server
                        yPos = json.yPos;  // overwrite from server

                        detectGameboardSectionJump(json.gbName, json.xGBSector, json.yGBSector);  // Check GB section jump

                        //draw();  // draw handled by emit
                    },
                    error: function () {
                        draw();  // draw base on local movement
                    }
                });


            });

            


            /*
            TODO: Launch Modal on items.  Using AJAX .load
            $("td").click(function () {
                //alert("The td was clicked.");
                alert(this.id);
            });
            */



            initGameBoard();  // add div #ids to cell
            initController(); // bind arrow keys
            initStartPosition(); // alert("#" + xPos + "-" + yPos);


            draw();         // first draw people
            drawItems();    // second draw objects

        });





        /***
            INITIALIZE THE GAME BOARD

            1. Add Co-ordinate to all TDs
            2. use xGBSector and yGBSector to start the game board co-ordinates

        ***/
        function initGameBoard() {

            var xCount, yCount;

            xCount = xGBSector;
            yCount = yGBSector;

            log("GAMEBOARD:" + gbName);

            $("tr").each(function () {

                $.each(this.cells, function () {
                    $(this).attr("id", xCount + "-" + yCount); // TD
                    
                    if (gbName == '#desert') {
                        $(this).attr("class", "tile-sand1"); // tile-grass1, tile-sand1
                    } else
                    {
                        $(this).attr("class", "tile-grass1"); // tile-grass1, tile-sand1
                    }

                    $(this).children('div').attr("id", "P-" + xCount + "-" + yCount); // child DIV
                    $(this).children('div').attr("class", "personHolder");
                    
                    yCount++;
                });

                xCount ++;
                yCount = yGBSector;
            });

            xMax = $("tr").size();      // set number of rows
            yMax = $("tr:first").children('td').size(); // set number of columns

        }

        /***
            INITIALIZE THE CONTROLLER
        ***/
        function initController() {

            $(window).bind('keydown', function (e) {

                if (e.keyCode == 37) {
                    e.preventDefault();
                    movement('left');

                } else if (e.keyCode == 38) {
                   e.preventDefault();
                    movement('up');

                } else if (e.keyCode == 39) {
                   e.preventDefault();
                    movement('right');

                } else if (e.keyCode == 40) {
                    e.preventDefault();
                    movement('down');
                }
            });

            // To Do: inventory hotkey?

        }


        //  NEW GAME
        function modalSelectPerson(modalName, modalRate) {

            icon = modalName;
            movementRate = modalRate;

            if (personID > 0) {
                npcArray[personID].icon = icon;
                draw();
            }
        }

        function initStartPosition() {
            movement('nothing');
        }


        //MOVE - DRAW LOCAL AND SEND DATA TO SERVER
        function movement(action) {

            if (Date.now() - tickCounter > movementRate) { // movement rate check

                // Local Draw
                switch (action) {
                    case "up":
                        xPos -= 1;
                        if (xPos < 1) xPos = 0;
                        break;
                    case "down":
                        xPos += 1;
                        if (xPos > xMax) xPos = xMax;
                        break;
                    case "left":
                        yPos -= 1;
                        if (yPos < 1) yPos = 0;
                        break;
                    case "right":
                        yPos += 1;
                        if (yPos > yMax) yPos = yMax;
                        break;

                    default:
                }

                // Server Draw, once personID has been obtained
                if (personID > 0) {

                    $.ajax({
                        type: "POST",
                        url: '/move',
                        data: { direction: action, personID: personID, icon: icon },
                        timeout: 100,
                        async: true,
                        dataType: 'text',   //you may use jsonp for cross origin request
                        crossDomain: true,
                        success: function (data, status) {

                            //log("Move-json:" + data);
                            var json = JSON.parse(data);

                            icon = json.icon;
                            xPos = json.xPos;  // overwrite from server
                            yPos = json.yPos;  // overwrite from server

                            detectGameboardSectionJump(json.gbName, json.xGBSector, json.yGBSector);  // Check GB section jump

                            $("#gb-section-long-lat").html('(' + json.xGBSector / +GLOBAL_SECTION_SIZE_X + ',' + json.yGBSector / GLOBAL_SECTION_SIZE_Y + ')') // update gameboard long/lat

                            //draw();  //No need to draw, as this is handled by the server EMIT 'new message'
                        },
                        error: function () {
                            draw();  // draw base on local movement
                        }
                    });


                    log("client:" + xPos + "-" + yPos);
                }

                tickCounter = Date.now();
            }  // end if movementRate
        }

        
        // Jump to new gameboard if found in new position
        function detectGameboardSectionJump(hashtag, x,y) {

            if (gbName != hashtag || x != xGBSector || y != yGBSector) {

                    gbName = hashtag;
                    xGBSector = x;
                    yGBSector = y;

                    initGameBoard();  // add div #ids, and texture
                    draw();
                    drawItems();      // draw items
                }
        }


        // The main draw routine
        function draw() {

            $("td div").removeClass("mia");
            $("td div").removeClass("naomi");
            $("td div").removeClass("monster-banana");
            $("td div").removeClass("monster-baby");
            $("td div").removeClass("monster-dino");
            $("td div").removeClass("monster-mount1");
            $("td div").removeClass("monster-mount2");
            $("td div").removeClass("monster-zombie1");
            $("td div").removeClass("fN");
            $("td div").removeClass("fE");
            $("td div").removeClass("fS");
            $("td div").removeClass("fW");


            //$("td div").removeClass();
            $("td div").attr("title", "");

            $("td div").off("click");  // remove all onclick events


            // Draw the other players, including self
            for (i = 0; i < npcArray.length; i++)
            {
                // ONLY DRAW IF ON THE SAME GAMEBOARD and SECTOR -  TO DO  - rebuild the npcArray instead for performance
                if (gbName == npcArray[i].gbName && xGBSector == npcArray[i].xGBSector && yGBSector == npcArray[i].yGBSector) {

                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].icon);            //$("#" + xPos + "-" + yPos).html("aaa");
                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].face);
                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("title", npcArray[i].firstName);

                    //log("array draw:" + i + "-" + npcArray[i].icon);
                    //log("DIV:" + "#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos + " " + npcArray[i].icon);


                    // TODO: attach an onclick event for special object.  i.e.  if( npcArray[i].modalID != null) 
                    if (npcArray[i].icon == "monster-mount1")
                    {
                        
                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("icon", npcArray[i].icon);

                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).click(function () {

                            modal($(this).attr("icon"));
                        });

                        
                    }

                }
            } // end for

        }


        // Draw item routine
        function drawItems() {
            $("td").removeClass("tile-tree1");
            $("#3-3").addClass("tile-tree1");
            $("td").removeClass("tile-tree2");
            $("#7-7").addClass("tile-tree2");

        }


        // Call modal - Describe objects, items, special activities
        function modal(keyName) {

            var loadTheModalURL = "/modalResponse.html?" + Date.now() + " #" + keyName;  // keep the # mark

            $("#myModalLabel").html("Description");
            $(".modal-body").load(loadTheModalURL);
            $("#myModal").modal("show");
        }



        // Send to gameboard Log
        function log(logString) {
            $("#gameBoardLog").prepend(logString + '<br>');
        }

        // Send to gameboard Log
        function resetLog(logString) {
            $("#gameBoardLog").html("");
        }


        // Check if NPC exists
        function findInArray(myArray, id) {

            var personExists = -1;

            for (i = 0; i < myArray.length; i++)
            {
                if (myArray[i].id == id) personExists = i; // found id!
            }

            return personExists;
        }

    </script>
</body>
</html>