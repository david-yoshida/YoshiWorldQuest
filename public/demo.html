<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="demo.css">

</head>

<body>
    <div class="container"><div class="mia"></div>

        <h1>Demo grid - node.js | bootstrap | jquery |  AJAX | css </h1>

        <div class="row well">
            <div class="col-md-3 personName" id="personName" contenteditable>Naomi Yoshida</div>
        </div>

        <div class="row well">
            <div class="col-md-9">
                <strong>Game Board</strong>
                <table id="gameBoard">
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr> 
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">
                <strong>Game Log</strong>
                <div id="gameBoardLog" class="gameBoardLog">
                   

                    <ul>
                        <li>Console interface - chat area?</li>
                        <li>Console interface - charactor, inventory, health?</li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="row well">
            <strong>Controls</strong>
            <button id="button-left" class="btn btn-default" type="submit">Left</button> 
            <button id="button-right" class="btn btn-default" type="submit">Right</button> 
            <button id="button-up" class="btn btn-default" type="submit">Up</button> 
            <button id="button-down" class="btn btn-default" type="submit">Down</button> 
            &nbsp;

            <button id="button-naomi" class="btn btn-default" type="submit">Naomi</button>
            <button id="button-mia" class="btn btn-default" type="submit">Mia</button>
            <button id="button-monster" class="btn btn-default" type="submit">Monster</button>
            &nbsp;
            <button id="button-new-game" class="btn btn-default" type="submit">New Game</button>
        </div>


        <div class="row well">
            Created by David Yoshida
        </div>

    </div>
    <script>

       
        // Init global vars;
        var xPos, yPos, xMax, yMax, icon, personID, tickCounter, movementRate;
        var npcArray;

        npcArray = new Array(0);

        icon = "naomi";
        personID = -1;
        movementRate = 100;
        tickCounter = 0;


        // Start the fun!
        $(document).ready(function () {

            var socket = io.connect();


            // Listen for server messages.
            socket.on('new message', function (data) {
                log('<strong>' + data + '</strong>');
            })
                
            // Listen for server messages.
            socket.on('new movement', function (data) {

                var json = JSON.parse(data);
                var index = findInArray(npcArray, json.id);

                if (index >= 0) {  // found!, so update co-ordinates
                    npcArray[index] = json;
                } else {
                    npcArray.push(json);
                }

                draw();  // Call the draw

            })

            socket.on('remove person', function (data) {
                var json = JSON.parse(data);
                log('<strong>' + data + '</strong>');

                var index = findInArray(npcArray, json.id);
                npcArray.splice(index, 1);
                draw();  // Call the draw

                if (personID == json.id) {
                    alert('game over!');
                    personID = -1;

                }
            })





            $("#button-left").click(function () {
                socket.emit('send message', 'Hello again Socket!');
                movement('left');
                
            });

            $("#button-right").click(function () {
                movement('right')
            });

            $("#button-up").click(function () {
                movement('up')
            });

            $("#button-down").click(function () {
                movement('down')
            });

            // NPC Test
            $("#button-naomi").click(function () {
                icon = "naomi";
                movementRate = 150;
                draw();
            });

            $("#button-mia").click(function () {
                icon = "mia";
                movementRate = 100;
                draw();
            });

            $("#button-monster").click(function () {
                movementRate = 0;
                icon = "monster-bananna";
                draw();
            });


            $("#button-new-game").click(function () {

                //  New game request
                $.ajax({
                    type: "POST",
                    url: '/newGame',
                    data: { name: $("#personName").html(), icon: icon },
                    async: true,
                    dataType: 'text',   //you may use jsonp for cross origin request
                    crossDomain: true,
                    success: function (data, status) {

                        var json = JSON.parse(data);                        
                        log("ser:" + json.id + "," + json.firstName + "," + json.xPos + "," + json.yPos);

                        personID = json.id;
                        xPos = json.xPos;  // overwrite from server
                        yPos = json.yPos;  // overwrite from server
                        draw();  // draw base on server map
                    },
                    error: function () {
                        draw();  // draw base on local movement
                    }
                });


            });

            /**
            $("td").click(function () {
                alert("The td was clicked.");
            });
            **/



            initGameBoard();  // add div #ids to cell
            initController(); // bind arrow keys
            initStartPosition(); // alert("#" + xPos + "-" + yPos);


            draw();         // first draw people
            drawItems();    // second draw objects


            $("#7-7").click(function () {
                alert("Pink Treasure box");
            });

        });





        /***
            INITIALIZE THE GAME BOARD

            1. Add Co-ordinate to all TDs
        ***/
        function initGameBoard() {

            var rCount = 0;
            var cCount = 0;

            $("tr").each(function () {

                $.each(this.cells, function () {
                    $(this).attr("id", rCount + "-" + cCount);
                    $(this).addClass("tile-grass1");  // remove for chess board

                    $(this).children('div').attr("id", "P-" + rCount + "-" + cCount);
                    //$(this).children('div').attr("class", "personHolder mia");
                    
                    cCount += 1;
                });

                rCount += 1;
                cCount = 0;
            });

            xMax = $("tr").size();      // set number of rows
            yMax = $("tr:first").children('td').size(); // set number of columns

        }

        /***
            INITIALIZE THE CONTROLLER
        ***/
        function initController() {

            $(window).bind('keydown', function (e) {

                if (e.keyCode == 37) {
                    movement('left');
                } else if (e.keyCode == 38) {
                    movement('up');
                } else if (e.keyCode == 39) {
                    movement('right');
                } else if (e.keyCode == 40) {
                    movement('down');
                }
            });

            // To Do: inventory hotkey?

        }

        function initStartPosition() {
            movement('nothing');
        }


        //MOVE - DRAW LOCAL AND SEND DATA TO SERVER
        function movement(action) {

            if (Date.now() - tickCounter > movementRate) { // movement rate check

                // Local Draw
                switch (action) {
                    case "up":
                        xPos -= 1;
                        if (xPos < 1) xPos = 0;
                        break;
                    case "down":
                        xPos += 1;
                        if (xPos > xMax) xPos = xMax;
                        break;
                    case "left":
                        yPos -= 1;
                        if (yPos < 1) yPos = 0;
                        break;
                    case "right":
                        yPos += 1;
                        if (yPos > yMax) yPos = yMax;
                        break;

                    default:
                }

                // Server Draw, once personID has been obtained
                if (personID > 0) {

                    $.ajax({
                        type: "POST",
                        url: '/move',
                        data: { direction: action, personID: personID, icon: icon },
                        timeout: 100,
                        async: true,
                        dataType: 'text',   //you may use jsonp for cross origin request
                        crossDomain: true,
                        success: function (data, status) {
                            //alert(data);
                            var json = JSON.parse(data);

                            log("server: id:" + json.id + " name:" + json.firstName + " x:" + json.xPos + " y:" + json.yPos);

                            xPos = json.xPos;  // overwrite from server
                            yPos = json.yPos;  // overwrite from server
                            draw();  // draw base on server map
                        },
                        error: function () {
                            draw();  // draw base on local movement
                        }
                    });


                    log("client:" + xPos + "-" + yPos);

                }

                tickCounter = Date.now();
            }  // end if movementRate
        }

        function draw() {

            $("div").removeClass("mia");
            $("div").removeClass("naomi");
            $("div").removeClass("monster-bananna");
            //$("#" + xPos + "-" + yPos).addClass(icon);            //$("#" + xPos + "-" + yPos).html("aaa");


            // Draw the other players
            for (i = 0; i < npcArray.length; i++)
            {
                $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].icon);
            }
                
        }


        // Draw item routine
        function drawItems() {
            
            $("#3-3").addClass("tile-tree1"); // 
            $("#7-7").addClass("tile-tree2");
            //$("#P-5-5").addClass("treasure") // test layer, perhaps terrain is background css, and image is foreground
        }

        // Send to gameboard Log
        function log(logString) {
            $("#gameBoardLog").prepend(logString + '<br>');
        }


        // Check if NPC exists
        function findInArray(myArray, id) {

            var personExists = -1;

            for (i = 0; i < myArray.length; i++)
            {
                if (myArray[i].id == id) personExists = i; // found id!
            }

            return personExists;
        }

    </script>
</body>
</html>