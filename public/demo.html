<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="demo.css">

</head>

<body>
    <div class="container"><div class="mia"></div>

        <h1>Demo grid - node.js | bootstrap | jquery |  AJAX | css </h1>

        <div class="row well">
            <div class="col-md-3 personName" id="personName" contenteditable>Naomi Yoshida</div>
        </div>

        <div class="row well">
            <div class="col-md-9">
                <strong>Game Board </strong><span id="gb-section-long-lat"></span>
                <table id="gameBoard">
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">
                <strong>Game Log</strong>
                <div id="gameBoardLog" class="gameBoardLog">
                   

                    <ul>
                        <li>Console interface - chat area?</li>
                        <li>Console interface - charactor, inventory, health?</li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="row well">
            <strong>Controls</strong>
            <button id="button-left" class="btn btn-default" type="submit">Left</button> 
            <button id="button-right" class="btn btn-default" type="submit">Right</button> 
            <button id="button-up" class="btn btn-default" type="submit">Up</button> 
            <button id="button-down" class="btn btn-default" type="submit">Down</button> 
            &nbsp;

            <button id="button-naomi" class="btn btn-default" type="submit">Naomi</button>
            <button id="button-mia" class="btn btn-default" type="submit">Mia</button>
            <button id="button-monster-banana" class="btn btn-default" type="submit">Monster Banana</button>
            <button id="button-monster-baby" class="btn btn-default" type="submit">Monster Baby</button>
            <!--<button id="button-monster-dino" class="btn btn-default" type="submit">Monster Dragon</button>-->
            &nbsp;

            <button id="button-random" class="btn btn-default" type="submit">random</button>
            

            <button id="button-new-game" class="btn btn-default" type="submit">New Game</button>
        </div>


        <div class="row well">
            Created by David Yoshida
        </div>

    </div>
    <script>
        var GLOBAL_SECTION_SIZE_X = 8;
        var GLOBAL_SECTION_SIZE_Y = 12;

        var xGBStartPosition = 0;    // x start position
        var yGBStartPosition = 0;   // y start position

        // Init global vars;
        var xPos, yPos, xMax, yMax, icon, personID, tickCounter, movementRate;
        var npcArray;

        npcArray = new Array(0);

        icon = "naomi";
        personID = -1;
        movementRate = 100;
        tickCounter = 0;


        // Start the fun!
        $(document).ready(function () {

            var socket = io.connect();

            // Listen for server messages.
            socket.on('new message', function (data) {
                log('<strong>' + data + '</strong>');
            })
                
            // Listen for server messages.
            socket.on('new movement', function (data) {
                //log('<strong>SERVER:' + data + '</strong>');
                var json = JSON.parse(data);
                var index = findInArray(npcArray, json.id);

                if (index >= 0) // found!, so update co-ordinates
                    npcArray[index] = json;
                else
                    npcArray.push(json);
                
                // Only draw person on the same gameboard section as you to save performance
                if (json.xSectionStart == xGBStartPosition && json.ySectionStart == yGBStartPosition)
                    draw();

            })

            socket.on('remove person', function (data) {

                var json = JSON.parse(data);
                log('<strong>' + data + '</strong>');

                var index = findInArray(npcArray, json.id);
                npcArray.splice(index, 1);
                draw();  // Call the draw

                if (personID == json.id) {
                    alert('game over!');
                    personID = -1;

                }
            })





            $("#button-left").click(function () {
                //socket.emit('send message', 'Hello again Socket!');
                movement('left');
                
            });

            $("#button-right").click(function () {
                movement('right')
            });

            $("#button-up").click(function () {
                movement('up')
            });

            $("#button-down").click(function () {
                movement('down')
            });

            // NPC Test
            $("#button-naomi").click(function () {
                icon = "naomi";
                movementRate = 150;

                if (personID > 0) {
                    npcArray[personID].icon = icon;
                    draw();
                }
                
                
            });

            $("#button-mia").click(function () {
                icon = "mia";
                movementRate = 100;

                if (personID > 0) {
                    npcArray[personID].icon = icon;
                    draw();
                }
               
               
            });

            $("#button-monster-banana").click(function () {
                icon = "monster-banana";
                movementRate = 0;

                if (personID > 0) {
                    npcArray[personID].icon = icon;
                    draw();
                }
                
               });


            $("#button-monster-baby").click(function () {
                icon = "monster-baby";
                movementRate = 0;

                if (personID > 0) {
                    npcArray[personID].icon = icon;
                    draw();
                }
            });


            $("#button-monster-dino").click(function () {
                movementRate = 0;
                icon = "monster-dino";
                draw();
            });

            $("#button-random").click(function () {
                alert(Math.floor((Math.random() * 10) + 1));
            });
            


            $("#button-new-game").click(function () {

                //  New game request
                $.ajax({
                    type: "POST",
                    url: '/newGame',
                    data: { name: $("#personName").html(), icon: icon },
                    async: true,
                    dataType: 'text',   //you may use jsonp for cross origin request
                    crossDomain: true,
                    success: function (data, status) {

                        var json = JSON.parse(data);                        

                        personID = json.id;
                        xPos = json.xPos;  // overwrite from server
                        yPos = json.yPos;  // overwrite from server

                        // Check if different gameboard section, then handle the relocation and re-draw
                        detectGameboardSectionJump(json.xSectionStart, json.ySectionStart);

                        //draw();  // draw handled by emit
                    },
                    error: function () {
                        draw();  // draw base on local movement
                    }
                });


            });

            

            /*
            TODO: Launch Modal on monsters.  Using AJAX .load
            $("td").click(function () {
                //alert("The td was clicked.");
                alert(this.id);
            });
            */



            initGameBoard();  // add div #ids to cell
            initController(); // bind arrow keys
            initStartPosition(); // alert("#" + xPos + "-" + yPos);


            draw();         // first draw people
            drawItems();    // second draw objects


            $("#7-7").click(function () {
                alert("Pink Treasure box");
            });

        });





        /***
            INITIALIZE THE GAME BOARD

            1. Add Co-ordinate to all TDs
            2. use xGBStartPosition and yGBStartPosition to start the game board co-ordinates

        ***/
        function initGameBoard() {

            var xCount, yCount;

            xCount = xGBStartPosition;
            yCount = yGBStartPosition;


            $("tr").each(function () {

                $.each(this.cells, function () {
                    $(this).attr("id", xCount + "-" + yCount); // TD
                    $(this).addClass("tile-grass1"); 

                    $(this).children('div').attr("id", "P-" + xCount + "-" + yCount); // child DIV
                    $(this).children('div').attr("class", "personHolder");
                    
                    yCount++;
                });

                xCount ++;
                yCount = yGBStartPosition;
            });

            xMax = $("tr").size();      // set number of rows
            yMax = $("tr:first").children('td').size(); // set number of columns

        }

        /***
            INITIALIZE THE CONTROLLER
        ***/
        function initController() {

            $(window).bind('keydown', function (e) {

                if (e.keyCode == 37) {
                    e.preventDefault();
                    movement('left');

                } else if (e.keyCode == 38) {
                   e.preventDefault();
                    movement('up');

                } else if (e.keyCode == 39) {
                   e.preventDefault();
                    movement('right');

                } else if (e.keyCode == 40) {
                    e.preventDefault();
                    movement('down');
                }
            });

            // To Do: inventory hotkey?

        }

        function initStartPosition() {
            movement('nothing');
        }


        //MOVE - DRAW LOCAL AND SEND DATA TO SERVER
        function movement(action) {

            if (Date.now() - tickCounter > movementRate) { // movement rate check

                // Local Draw
                switch (action) {
                    case "up":
                        xPos -= 1;
                        if (xPos < 1) xPos = 0;
                        break;
                    case "down":
                        xPos += 1;
                        if (xPos > xMax) xPos = xMax;
                        break;
                    case "left":
                        yPos -= 1;
                        if (yPos < 1) yPos = 0;
                        break;
                    case "right":
                        yPos += 1;
                        if (yPos > yMax) yPos = yMax;
                        break;

                    default:
                }

                // Server Draw, once personID has been obtained
                if (personID > 0) {

                    $.ajax({
                        type: "POST",
                        url: '/move',
                        data: { direction: action, personID: personID, icon: icon },
                        timeout: 100,
                        async: true,
                        dataType: 'text',   //you may use jsonp for cross origin request
                        crossDomain: true,
                        success: function (data, status) {

                            //log("Move-json:" + data);
                            var json = JSON.parse(data);

                            xPos = json.xPos;  // overwrite from server
                            yPos = json.yPos;  // overwrite from server
                            icon = json.icon;

                            // Check if different gameboard section, then handle the relocation and re-draw
                            detectGameboardSectionJump(json.xSectionStart, json.ySectionStart);

                            $("#gb-section-long-lat").html('(' + json.xSectionStart / +GLOBAL_SECTION_SIZE_X + ',' + json.ySectionStart / GLOBAL_SECTION_SIZE_Y + ')') // update gameboard long/lat

                            //draw();  //No need to draw, as this is handled by the server EMIT 'new message'
                        },
                        error: function () {
                            draw();  // draw base on local movement
                        }
                    });


                    log("client:" + xPos + "-" + yPos);

                }

                tickCounter = Date.now();
            }  // end if movementRate
        }

        
        // Jump to new gameboard if found in new position
        function detectGameboardSectionJump(x,y) {

            if (x != xGBStartPosition || y != yGBStartPosition) {
                    xGBStartPosition = x;
                    yGBStartPosition = y;
                    initGameBoard();  // add div #ids
                    drawItems();      // draw items
                    draw();
                }
        }

        function draw() {
            
            $("div").removeClass("mia");
            $("div").removeClass("naomi");
            $("div").removeClass("monster-banana");
            $("div").removeClass("monster-baby");
            $("div").removeClass("monster-dino");
            $("div").removeClass("title");

            // Draw the other players, including self
            for (i = 0; i < npcArray.length; i++)
            {
                $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].icon);            //$("#" + xPos + "-" + yPos).html("aaa");
                $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("title", npcArray[i].firstName);
                //log("array draw:" + i + "-" + npcArray[i].icon);
            }

        }


        // Draw item routine
        function drawItems() {
            $("td").removeClass("tile-tree1");
            $("#3-3").addClass("tile-tree1");
            $("td").removeClass("tile-tree2");
            $("#7-7").addClass("tile-tree2");

        }

        // Send to gameboard Log
        function log(logString) {
            $("#gameBoardLog").prepend(logString + '<br>');
        }


        // Check if NPC exists
        function findInArray(myArray, id) {

            var personExists = -1;

            for (i = 0; i < myArray.length; i++)
            {
                if (myArray[i].id == id) personExists = i; // found id!
            }

            return personExists;
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
</body>
</html>