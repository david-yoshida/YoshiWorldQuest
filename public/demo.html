<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <!-- Include meta tag to ensure proper rendering and touch zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Yoshi Adventure Quest</title>

    <!-- Include jQuery Mobile stylesheets -->
    <!--<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">-->

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- Include the jQuery Mobile library -->
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="demo.css">
</head>

<body>
    <div class="container"><div class="mia"></div>

        <h1>Demo grid - node.js | bootstrap | jquery |  AJAX | css </h1>

        <div class="row well">
            <div class="col-md-3 personName" id="personName" contenteditable>Naomi Yoshida</div>
            <div class="col-md-6"> 

                <div class="btn-group" role="group" aria-label="...">
                    <button id="person-mode-normal" class="btn btn-primary person-mode active" type="submit"><span class="glyphicon glyphicon-picture" aria-hidden="true"></span> ADVENTURE</button>
                    <button id="person-mode-attack" class="btn btn-primary person-mode" type="submit"><span class="glyphicon glyphicon-fire" aria-hidden="true"></span> ATTACK</button>
                    <button id="person-mode-quiet" class="btn btn-primary person-mode" type="submit"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> QUIET</button>
                    <button id="person-mode-flee" class="btn btn-primary person-mode" type="submit"><span class="glyphicon glyphicon-bell" aria-hidden="true"></span> FLEE</button>
                    <button id="person-mode-rest" class="btn btn-primary person-mode" type="submit"><span class="glyphicon glyphicon-tent" aria-hidden="true"></span> REST</button>
                </div>
            </div>
            <div class="col-md-3">
                Hit Points <span id="person-hp" class="badge">10</span>
                XP <span id="person-xp" class="badge">0</span>
                Players <span id="person-gb-count" class="badge">0</span>
            </div>


            
        </div>

        <div class="row well">
            <div class="col-md-9">
                <strong>Game Board </strong><span id="gb-section-long-lat"></span>
                <table id="gameBoard">
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                    <tr class="gb-row">
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                        <td><div></div></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">

                <table>
                    <tr>
                        <td></td>
                        <td><button id="button-up" class="btn btn-default" type="submit" data-icon="arrow-u">&nbsp;</button></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td><button id="button-left" class="btn btn-default" type="submit" data-icon="arrow-l">&nbsp;</button></td>
                        <td></td>
                        <td><button id="button-right" class="btn btn-default" type="submit" data-icon="arrow-r">&nbsp;</button></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><button id="button-down" class="btn btn-default" type="submit" data-icon="arrow-d">&nbsp;</button></td>
                        <td></td>
                    </tr>

                </table>
                
               
                <button id="button-new-game" class="btn btn-default" type="submit">New Game</button>


                <strong>Game Log</strong>
                <div id="gameBoardLog" class="gameBoardLog">


                    <ul>
                        <li>Console interface - chat area?</li>
                        <li>Console interface - charactor, inventory, health?</li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="row well">

            <button id="button-clear-log" class="btn btn-default" type="submit">Clear log</button>
            <button id="button-modal" class="btn btn-default" type="submit">Launch Modal</button>
            <button id="button-attack-hit" class="btn btn-default" type="submit">Attack hit</button>
            
        </div>


        <div class="row well">
            Created by David Yoshida
        </div>

    </div>


    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h1 class="modal-title" id="myModalLabel">Modal title</h1>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer center">

                    <button id="btn-modal-close" type="button" class="btn btn-success btn-modal" data-dismiss="modal">Close</button>
                    <button id="btn-modal-start-game" class="btn btn-default btn-modal" type="submit" data-dismiss="modal">Start New Game</button>
                    &nbsp;
                    <button id="btn-modal-attack" type="button" class="btn btn-primary btn-modal">Attack</button>
                    <button id="btn-modal-enter" type="button" class="btn btn-primary btn-modal">Enter</button>

                   
                </div>
            </div>
        </div>
    </div>


    <script>
        var GLOBAL_SECTION_SIZE_X = 8;
        var GLOBAL_SECTION_SIZE_Y = 12;

        var xGBSector = 0; // GB sector co-ordinates
        var yGBSector = 0; // GB sector co-ordinates

        // Init global vars;
        var xPos, yPos, xMax, yMax, icon, personID, tickCounter, movementRate;
        var npcArray;

        npcArray = new Array(0);

        hp = 0;
        xp = 0;
        playerGBCount = 0;
        icon = "naomi";
        personID = -1;
        gbName = "nil";
        movementRate = 170;
        tickCounter = 0;
        gsInstance = 0;


        // Start the fun!
        $(document).ready(function () {

            var socket = io.connect();

            // Listen for server messages.
            socket.on('new message', function (data) {
                log('<strong>' + data + '</strong>');
            })
                
            // Listen for server messages.
            socket.on('new movement', function (data) {
                log('<strong>SERVER:' + data + '</strong>'); //DEBUG MOVEMENT PERFORMANCE : 
                var personChangeDetected = false;
                var json = JSON.parse(data);

                var index = findInArray(npcArray, json.id);

                if (index >= 0) { // found!, so update co-ordinates

                    if (json.face == 'fN' || json.face == 'fS') json.face = npcArray[index].face;  // Leave the last facing direction on N and S movement
                    //if (json.face == 'fN') json.face = npcArray[index].face;  // Leave the last facing direction on N and S movement

                    if (npcArray[index].xPos != json.xPos || npcArray[index].yPos != json.yPos || npcArray[index].icon != json.icon) {
                        personChangeDetected = true;  // This person's position or icon changed from what we have in our array, so draw!
                    }

                    npcArray[index] = json;
                    // KEEP TO TROUBLESHOOT PERFORMANCE - alert(npcArray[index].pGBCount + '-' + data);
                }
                else
                {
                    npcArray.push(json);
                    personChangeDetected = true;
                }
                    
                
                // Only draw person on the same gameboard section as you to save performance
                if (json.xGBSector == xGBSector && json.yGBSector == yGBSector && personChangeDetected)

                  if (!json.isObject) { // Only draw moving items
                        draw();
                 }
                           

            })

            socket.on('remove person', function (data) {

                //log('<strong>' + data + '</strong>');

                var json = JSON.parse(data);

                log('<strong>' + json.firstName + '</strong>' + ' has left the game.');

                var index = findInArray(npcArray, json.id);
                npcArray.splice(index, 1);
                draw();  // Call the draw

                if (personID == json.id) {
                    gameOverRoutine('dead');

                }
            })





            $("#button-left").click(function () {
                movement('left');
            });

            $("#button-right").click(function () {
                movement('right')
            });

            $("#button-up").click(function () {
                movement('up')
            });

            $("#button-down").click(function () {
                movement('down')
            });


            
            $("#button-clear-log").click(function () {
                resetLog();
            });

            $("#button-modal").click(function () {
                modal("monster-mount1");
            });



            $("#button-new-game").click(function () {

                modal("start-game", new Array("btn-modal-close", "btn-modal-start-game"));
            });


            $("#button-attack-hit").click(function () {
                $('body').css('background-color', 'red');
                
                setTimeout(function () {
                    //    $rows.removeClass("pageLoad");
                    $('body').css('background-color', 'lightblue');
                }, 500);

            });




            $("#btn-modal-start-game").click(function () {

                //  New game request
                $.ajax({
                    type: "POST",
                    url: '/newGame',
                    data: { name: $("#personName").html(), icon: icon },
                    async: true,
                    dataType: 'text',   //you may use jsonp for cross origin request
                    crossDomain: true,
                    success: function (data, status) {

                        var json = JSON.parse(data);                        

                        personID = json.id;
                        xPos = json.xPos;  // overwrite from server
                        yPos = json.yPos;  // overwrite from server
                        gsInstance = json.gsInstance;

                        detectGameboardSectionJump(json.gbName, json.xGBSector, json.yGBSector);  // Check GB section jump

                        //draw();  // draw handled by emit
                    },
                    error: function () {
                        draw();  // draw base on local movement
                    }
                });


            });

            // Change person mode buttons
            $("#person-mode-normal").click(function () {
                personModeChange('normal');
            });

            $("#person-mode-attack").click(function () {
                personModeChange('attack');
            });
           
            $("#person-mode-quiet").click(function () {
                personModeChange('quiet');
            });

            $("#person-mode-flee").click(function () {
                personModeChange('flee');
            });

            $("#person-mode-rest").click(function () {
                personModeChange('rest');
            });


            initGameBoard();        // add div #ids to cell
            initController();       // bind arrow keys
            initStartPosition();    // alert("#" + xPos + "-" + yPos);


            draw();         // first draw people
            drawItems();    // second draw objects

        });





        /***
            INITIALIZE THE GAME BOARD

            1. Add Co-ordinate to all TDs
            2. use xGBSector and yGBSector to start the game board co-ordinates

        ***/
        function initGameBoard() {

            var xCount, yCount;

            xCount = xGBSector;
            yCount = yGBSector;

            $(".gb-row").each(function () {

                $.each(this.cells, function () {
                    $(this).attr("id", xCount + "-" + yCount); // TD
                    
                    if (gbName == '#desert') {
                        $(this).attr("class", "tile-sand1"); // tile-grass1, tile-sand1
                    } else
                    {
                        $(this).attr("class", "tile-grass1"); // tile-grass1, tile-sand1
                    }

                    $(this).children('div').attr("id", "P-" + xCount + "-" + yCount); // child DIV
                    $(this).children('div').attr("class", "personHolder");
                    
                    yCount++;
                });

                xCount ++;
                yCount = yGBSector;
            });

            xMax = $(".gb-row").size();      // set number of rows
            yMax = $(".gb-row:first").children('td').size(); // set number of columns

        }

        /***
            INITIALIZE THE CONTROLLER
        ***/
        function initController() {

            $(window).bind('keydown', function (e) {

                if (e.keyCode == 37) {
                    e.preventDefault();
                    movement('left');

                } else if (e.keyCode == 38) {
                   e.preventDefault();
                    movement('up');

                } else if (e.keyCode == 39) {
                   e.preventDefault();
                    movement('right');

                } else if (e.keyCode == 40) {
                    e.preventDefault();
                    movement('down');
                }
            });

            // To Do: inventory hotkey?

        }


        //  NEW GAME
        function modalSelectPerson(modalName, modalRate) {

            icon = modalName;
            movementRate = modalRate;

            if (personID > 0) {
                npcArray[personID].icon = icon;
                draw();
            }
        }

        function initStartPosition() {
            movement('nothing');
        }


        //MOVE - DRAW LOCAL AND SEND DATA TO SERVER
        function movement(action) {
            
            if (Date.now() - tickCounter > movementRate) { // movement rate check

                // Local Draw
                switch (action) {
                    case "up":
                        xPos -= 1;
                        if (xPos < 1) xPos = 0;
                        break;
                    case "down":
                        xPos += 1;
                        if (xPos > xMax) xPos = xMax;
                        break;
                    case "left":
                        yPos -= 1;
                        if (yPos < 1) yPos = 0;
                        break;
                    case "right":
                        yPos += 1;
                        if (yPos > yMax) yPos = yMax;
                        break;

                    default:
                }

                // Server Draw, once personID has been obtained
                if (personID > 0) {

                    $.ajax({
                        type: "POST",
                        url: '/move',
                        data: { direction: action, personID: personID, icon: icon, gsInstance: gsInstance },
                        timeout: 100,
                        async: true,
                        dataType: 'text',   //you may use jsonp for cross origin request
                        crossDomain: true,
                        success: function (data, status) {

                            var json = JSON.parse(data);


                            if (gsInstance == json.gsInstance) // game server reset detected!
                            {
                                icon = json.icon;
                                xPos = json.xPos;  // take from server
                                yPos = json.yPos;  // take from server
                                movementRate = json.movementRate;

                                detectGameboardSectionJump(json.gbName, json.xGBSector, json.yGBSector);  // Check GB section jump

                                // update gameboard long/lat label
                                $("#gb-section-long-lat").html('(' + json.xGBSector / +GLOBAL_SECTION_SIZE_X + ',' + json.yGBSector / GLOBAL_SECTION_SIZE_Y + ')') 
                            }
                            else
                            {
                                gameOverRoutine('server-reset');
                            }

                            //draw();  //No need to draw, as this is handled by the server EMIT 'new message'
                        },
                        error: function () {
                            draw();  // draw base on local movement
                        }
                    });


                    //log("client:" + xPos + "-" + yPos + " m:"+ movementRate); // DEBUG person movement
                }

                tickCounter = Date.now();
            }  // end if movementRate
        }

        
        // Jump to new gameboard if found in new position
        function detectGameboardSectionJump(hashtag, x, y) {

            if (gbName != hashtag || x != xGBSector || y != yGBSector) {

                if (gbName != hashtag) log("Welcome to Gameboard :" + hashtag);

                    gbName = hashtag;
                    xGBSector = x;
                    yGBSector = y;

                    initGameBoard();  // add div #ids, and texture
                    draw();
                    drawItems();      // draw items
                }
        }


        // The main draw routine
        function draw() {

            //alert('draw called!');

            /*
            $("td div").removeClass("mia");
            $("td div").removeClass("naomi");
            $("td div").removeClass("monster-banana");
            $("td div").removeClass("monster-baby");
            $("td div").removeClass("monster-dino");
            $("td div").removeClass("monster-mount1");
            $("td div").removeClass("monster-mount2");
            $("td div").removeClass("monster-zombie1");
            $("td div").removeClass("monster-crow1");
            $("td div").removeClass("fN");
            $("td div").removeClass("fE");
            $("td div").removeClass("fS");
            $("td div").removeClass("fW");
            */

            // clean up old table cell div classes, titles and click events
            $(".gb-row td div").attr("class", "personHolder");
            $("td div").attr("title", "");
            $("td div").off("click");

            // Draw the other players, including self
            for (i = 0; i < npcArray.length; i++)
            {
                // ONLY DRAW IF ON THE SAME GAMEBOARD and SECTOR -  TO DO  - rebuild the npcArray instead for performance
                if (gbName == npcArray[i].gbName && xGBSector == npcArray[i].xGBSector && yGBSector == npcArray[i].yGBSector) {

                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].icon);            //$("#" + xPos + "-" + yPos).html("aaa");
                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).addClass(npcArray[i].face);
                    $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("title", npcArray[i].firstName);

                    //log("array draw:" + i + "-" + npcArray[i].icon);
                    //log("DIV:" + "#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos + " " + npcArray[i].icon);


                    // TODO: attach an onclick event for special object.  i.e.  if( npcArray[i].modalID != null)  add in Monster servers side attribute
                    if (npcArray[i].icon == "monster-mount1" || npcArray[i].icon == "monster-crow1")
                    {
                        
                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("icon", npcArray[i].icon);
                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).click(function () {
                            modal($(this).attr("icon"));
                        });

                        
                    } else if (npcArray[i].icon == "object-treasurebox1") {

                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).attr("icon", npcArray[i].icon);
                        $("#P-" + npcArray[i].xPos + "-" + npcArray[i].yPos).click(function () {
                            modal($(this).attr("icon"));
                        });
                    }

                }

                // Found self in npcArray! The array push can take place out of order.  So personID does not match array ID [i]
                if (personID > 0 && npcArray[i].id == personID) {
                    //alert('update!' + npcArray[i].pGBCount);
                    $("#person-hp").text(npcArray[i].pHP);
                    $("#person-xp").text(npcArray[i].pXP);
                    //$("#person-gb-count").text(npcArray[i].pGBCount);
                    $("#person-gb-count").text(npcArray[i].pGBCount);
                }

            } // end for

        }


        // Draw item routine
        function drawItems() {
            $("td").removeClass("tile-tree1");
            $("td").removeClass("tile-tree2");

            //$("#3-3").addClass("tile-tree1");
            //$("#5-5").addClass("tile-tree2");

        }


        // Call modal - Describe objects, items, special activities
        function modal(keyName, btnArray) {

            $(".btn-modal").hide();

            if (typeof btnArray != 'undefined') 
            {
                for (i = 0; i < btnArray.length; i++) {  // activate modal buttons
                    $("#" + btnArray[i]).show();
                }
            } else {
                $("#btn-modal-close").show();
            }

            var loadTheModalURL = "/modalResponse.html?" + Date.now() + " #" + keyName;  // keep the # mark

            $("#myModalLabel").html("Description");
            $(".modal-body").load(loadTheModalURL);
            $("#myModal").modal("show");
        }


        function gameOverRoutine(actionText) {
            personID = -1;
            npcArray = [];

            // reset game
            initGameBoard();// add div #ids, and texture
            //initController(); 
            initStartPosition();
            
            modal(actionText);

            //alert('game over!');  // TODO: Game over change to modal
        }

        // Send to gameboard Log
        function log(logString) {
            $("#gameBoardLog").prepend(logString + '<br>');
        }

        // Send to gameboard Log
        function resetLog(logString) {
            $("#gameBoardLog").html("");
        }

        // Change the persion mode - Adventure, Attack, etc.
        function personModeChange(modeName) {

            $("person-mode").removeClass("active");
           
            if (personID > 0) { // Server call to change mode once personID has been obtained

                $.ajax({
                    type: "POST",
                    url: '/mode',
                    data: { mode: modeName, personID: personID, },
                    timeout: 100,
                    async: true,
                    dataType: 'text',   //you may use jsonp for cross origin request
                    crossDomain: true,
                    success: function (data, status) {

                        var json = JSON.parse(data);

                        personMode = json.mode;
                        movementRate = json.movementRate;
                        tickCounter = Date.now() + movementRate; // reset tick counter

                        $(".person-mode").removeClass("active");
                        $("#person-mode-" + modeName).addClass("active");

                        //log("mode-json:" + data);  // DEBUG: changing person modes
                    },
                    error: function () {

                    }
                });

                
            }   

        }


        // Check if NPC exists
        function findInArray(myArray, id) {

            var personExists = -1;

            for (i = 0; i < myArray.length; i++)
            {
                if (myArray[i].id == id) personExists = i; // found id!
            }

            return personExists;
        }

    </script>
</body>
</html>