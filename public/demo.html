<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="demo.css">

</head>

<body>
    <div class="container">

        <h1>Demo grid - node.js | bootstrap | jquery |  AJAX | css </h1>

        <div class="row well">
            Hello
        </div>

        <div class="row well">
            <div class="col-md-9">
                <strong>Game Board</strong>
                <table id="gameBoard">
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-3">
                <strong>Game Log</strong>
                <div id="gameBoardLog" class="gameBoardLog">
                   

                    <ul>
                        <li>Console interface - chat area?</li>
                        <li>Console interface - charactor, inventory, health?</li>
                    </ul>
                </div>

            </div>
        </div>
        <div class="row well">
            <h2>Controls</h2>
            <button id="button-left" class="btn btn-default" type="submit">Left</button> 
            <button id="button-right" class="btn btn-default" type="submit">Right</button> 
            <button id="button-up" class="btn btn-default" type="submit">Up</button> 
            <button id="button-down" class="btn btn-default" type="submit">Down</button> 

            <button id="button-naomi" class="btn btn-default" type="submit">Naomi</button>
            <button id="button-mia" class="btn btn-default" type="submit">Mia</button>
            <button id="button-monster" class="btn btn-default" type="submit">Monster</button>
        </div>


        <div class="row well">
            Created by David Yoshida
        </div>

    </div>
    <script>

       
        // Init global vars;
        var xPos, yPos, xMax, yMax, characterName;

        

        characterName = "naomi";

        // Start the fun!
        $(document).ready(function () {

            var socket = io.connect();


            // Listen for server messages.
            socket.on('new message', function (data) {
                log('<strong>' + data + '</strong>');
            })
                

            $("#button-left").click(function () {
                socket.emit('send message', 'Hello again Socket!');
                movement('left');
                
            });

            $("#button-right").click(function () {
                movement('right')
            });

            $("#button-up").click(function () {
                movement('up')
            });

            $("#button-down").click(function () {
                movement('down')
            });

            $("#button-naomi").click(function () {
                characterName = "naomi";
                draw();
            });

            $("#button-mia").click(function () {
                characterName = "mia";
                draw();
            });

            $("#button-monster").click(function () {
                characterName = "monster-bananna";
                draw();
            });


            /**
            $("td").click(function () {
                alert("The td was clicked.");
            });
            **/



            initGameBoard();  // add div #ids to cell
            initController(); // bind arrow keys
            initStartPosition(); // alert("#" + xPos + "-" + yPos);

            
            //movement('null');  // Call server to get position

            draw();         // first draw people
            drawItems();    // second draw objects


            $("#7-7").click(function () {
                alert("Pink Treasure box");
            });

        });





        /***
            INITIALIZE THE GAME BOARD

            1. Add Co-ordinate to all TDs
        ***/
        function initGameBoard() {

            var rCount = 0;
            var cCount = 0;

            $("tr").each(function () {

                $.each(this.cells, function () {
                    $(this).attr("id", rCount + "-" + cCount);
                    cCount += 1;
                });

                rCount += 1;
                cCount = 0;
            });

            xMax = $("tr").size();      // set number of rows
            yMax = $("tr:first").children('td').size(); // set number of columns

        }

        /***
            INITIALIZE THE CONTROLLER
        ***/
        function initController() {

            $(window).bind('keydown', function (e) {

                if (e.keyCode == 37) {
                    movement('left');
                } else if (e.keyCode == 38) {
                    movement('up');
                } else if (e.keyCode == 39) {
                    movement('right');
                } else if (e.keyCode == 40) {
                    movement('down');
                }
            });

            // To Do: inventory hotkey?

        }

        function initStartPosition() {
            movement('nothing');
        }


        //MOVE - DRAW LOCAL AND SEND DATA TO SERVER
        function movement(action) {

            // Local Draw
            switch (action) {
                case "up":
                    xPos -= 1;
                    if (xPos < 1) xPos = 0;
                    break;
                case "down":
                    xPos += 1;
                    if (xPos > xMax) xPos = xMax;
                    break;
                case "left":
                    yPos -= 1;
                    if (yPos < 1) yPos = 0;
                    break;
                case "right":
                    yPos += 1;
                    if (yPos > yMax) yPos = yMax;
                    break;

                default:
            }

            //draw();  // draw local


            // Server Draw
            $.ajax({
                type: "POST",
                url: 'http://yoshiworld.goradii.com:3000/',
                data: { direction: action },
                timeout:100,
                async: true,
                dataType: 'text',   //you may use jsonp for cross origin request
                crossDomain: true,
                success: function (data, status) {
                    // alert(data);
                    var json = JSON.parse(data);
                   
                    log("ser:" + json.firstName + "," + json.xPos + "," + json.yPos);

                    xPos = json.xPos;  // overwrite from server
                    yPos = json.yPos;  // overwrite from server
                    draw();  // draw base on server map
                },
                error: function () {
                    draw();  // draw base on local movement
                }
            });


            log("cli:" + xPos + "-" + yPos);
        }

        function draw() {

            $("td").removeClass("mia")
            $("td").removeClass("naomi")
            $("td").removeClass("monster-bananna")
            $("#" + xPos + "-" + yPos).addClass(characterName)            //$("#" + xPos + "-" + yPos).html("aaa");

        }


        // Draw item routine
        function drawItems() {

            $("#3-3").addClass("treasure")
            $("#7-7").addClass("treasure")

        }

        // Send to gameboard Log
        function log(logString) {
            $("#gameBoardLog").prepend(logString + '<br>');
        }

    </script>
</body>
</html>